---
title: CORS--跨域资源共享
tags:
  - 跨域问题
  - cors
  - 资源共享
  - node.js
categories:
  - JavaScript基础
abbrlink: 9f59301e
date: 2024-08-11 22:04:52
description: 本文介绍浏览器对跨域访问资源的限制，以及解决方案
sticky: 1
swiper_index: 1
top_img: https://tuchuang.voooe.cn/images/2024/08/11/girls_1920x1080.webp
cover: https://tuchuang.voooe.cn/images/2024/08/11/shawu_3840x2880.webp
---

# 域（源）

&nbsp;&nbsp;&nbsp;&nbsp;由域名、协议、端口号三部分组成

# 跨域的定义

&nbsp;&nbsp;&nbsp;&nbsp;一个域向另一个域的服务器请求数据, 跨域也称跨源（Origin）, 一般根据http/https请求中Origin判断

# 跨域问题

&nbsp;&nbsp;&nbsp;&nbsp;浏览器出于安全考虑，基于同源策略，限制js代码中<abbr title="XMLHttpRequest">XHR</abbr>对象和[Fetch API](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)对跨域资源的访问。默认情况下，不限制js发送请求，但限制js接收不合规的响应。

**注：浏览器仅进行简单的对比判断，域名、协议、端口号必须完全一致，不接受域名重定向或者同一主机的不同
域名，例如localhost和127.0.0.1会判断为不同域名。**

# 解决方案

&nbsp;&nbsp;&nbsp;&nbsp;根据跨域问题的定义，可以考虑到以下两种方式：

- Jsonp方式：不使用任何需要借助XHR对象或Fetch API的工具，而是通过向html中动态插入包含请求api的script标签的方式发送请求(GET)请求，由服务端发送Jsonp类型数据给请求方。

- CORS机制：通过在跨域服务器的响应标头中插入包含请求源域名的`Access-Control-Allow-Origin`字段的方式，来允许浏览器获取该跨域资源。

## Jsonp方式

&nbsp;&nbsp;&nbsp;&nbsp;该方式需要提供回调函数作为请求参数,且服务器端必须支持以<abbr title="Json with Padding">Jsonp</abbr>形式返回响应。本质上是发送携带json数据的js代码片段给客户端浏览器执行，该代码片段中的内容大致为：将请求数据作为形参传入给定的回调函数以执行，因此，该回调函数是由请求方定义的，并需要服务器提供数据作为参数，以便在回调函数中对数据进行处理。
&nbsp;&nbsp;&nbsp;&nbsp;例如要从`http://example.com/getData`获取数据，并希望使用`handleData`作为回调函数：

```JavaScript
<script>
    function handleData(data) {
        console.log(data);
    }
</script>
<script src="http://example.com/getData?callback=handleData"></script>
```

&nbsp;&nbsp;&nbsp;&nbsp;支持传输jsonp类型数据的跨域服务器可能会返回如下数据:

```JavaScript
handleData({ 'name': 'Alice', 'age': 30 });
```

**注：服务器返回的是一个函数调用的表达式，而不是函数本身或函数的定义。**

## CORS机制

&nbsp;&nbsp;&nbsp;&nbsp; CORS 通过 HTTP 请求头的方式，允许服务器声明哪些源可以访问它的资源，以及允许哪些类型的请求（GET、POST、PUT 等）。浏览器在请求时会自动处理这些头信息，并根据服务器的响应决定是否允许跨域请求。

### 1. 简单请求

&nbsp;&nbsp;&nbsp;&nbsp;对于简单请求， CORS 机制直接通过两个 HTTP 头来控制访问：

- Origin: 由浏览器自动添加到请求中，表示发起请求的源（协议 + 域名 + 端口）。
- Access-Control-Allow-Origin: 由服务器在响应中返回，指明允许哪些源访问资源。
&nbsp;&nbsp;&nbsp;&nbsp;例如，浏览器发起如下请求：

```http
GET /data HTTP/1.1
Host: api.example.com
Origin: http://mywebsite.com
```

&nbsp;&nbsp;&nbsp;&nbsp;服务器的响应：

```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://mywebsite.com
```

&nbsp;&nbsp;&nbsp;&nbsp;如果服务器响应的`Access-Control-Allow-Origin` 包含发起请求的源（如 <http://mywebsite.com>），浏览器就允许这个跨域请求并将数据传递给 JavaScript 代码。

### 2. 预检请求（Preflight Request）

&nbsp;&nbsp;&nbsp;&nbsp;对于非简单请求（例如，带有自定义头信息的 POST 请求），浏览器会在实际请求前发送一个预检请求，目的是确认服务器是否允许这种跨域请求。
&nbsp;&nbsp;&nbsp;&nbsp;预检请求通常是一个 OPTIONS 请求，类似如下：

```http
OPTIONS /data HTTP/1.1
Host: api.example.com
Origin: http://mywebsite.com
Access-Control-Request-Method: POST
```

&nbsp;&nbsp;&nbsp;&nbsp;服务器响应：

```http
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://mywebsite.com
Access-Control-Allow-Methods: POST, GET, OPTIONS
Access-Control-Allow-Headers: Content-Type
```

&nbsp;&nbsp;&nbsp;&nbsp;如果服务器响应允许请求的方法和头信息，浏览器才会发送实际的请求。

### 3. 其他重要的CORS头信息

- Access-Control-Allow-Credentials：是否允许发送凭据（如 cookies、HTTP 认证信息）。
- Access-Control-Expose-Headers：指定哪些响应头可以在浏览器中访问。
- Access-Control-Max-Age：指定预检请求的结果可以缓存多长时间。

### CORS 的作用

&nbsp;&nbsp;&nbsp;&nbsp;CORS 通过控制浏览器行为来防止不受信任的跨域请求，避免可能的安全风险。它允许服务器灵活地指定允许的跨域资源访问规则，从而使得 Web 应用能够安全地跨域获取资源。

### 总结

&nbsp;&nbsp;&nbsp;&nbsp;CORS 是一种标准化的机制，允许服务器通过 HTTP 头来控制哪些外部域可以访问其资源，从而在提升跨域请求灵活性的同时，保持对跨域请求的安全性控制。
